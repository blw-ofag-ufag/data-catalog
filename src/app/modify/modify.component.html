<div class="container py-4">
	<div class="row">
		<div class="col-12">
			<!-- Header -->
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h1>
					{{ (isEditMode ? "modify.auth.form.title.edit" : "modify.auth.form.title.new") | translate }}
				</h1>
				<div class="d-flex align-items-center gap-2">
					<small class="text-muted">{{ "modify.auth.form.selectedRepository" | translate }}:</small>
					<strong class="me-3">{{ getSelectedRepositoryDisplay() }}</strong>
					<a routerLink="/modify/auth" class="btn btn-outline-info btn-sm">
						{{ "modify.auth.form.changeRepository" | translate }}
					</a>
				</div>
			</div>

			<!-- Dataset Form -->
			<div class="dataset-form-container" *ngIf="!showSubmitSection">
				<form [formGroup]="datasetForm" (ngSubmit)="onSubmit()">
					<!-- Basic Information Section -->
					<div class="card mb-4">
						<div class="card-header">
							<h4>{{ "modify.auth.form.sections.basic" | translate }}</h4>
						</div>
						<div class="card-body">
							<app-multilingual-text-field
								formControlName="dct:title"
								[label]="'labels.dct:title'"
								[placeholder]="'modify.auth.form.placeholders.title'"
								[required]="true"
							>
							</app-multilingual-text-field>

							<app-multilingual-text-field
								formControlName="dct:description"
								[label]="'labels.dct:description'"
								[placeholder]="'modify.auth.form.placeholders.description'"
								[required]="true"
								[textarea]="true"
								[maxLength]="2000"
							>
							</app-multilingual-text-field>

							<app-keyword-array-field formControlName="dcat:keyword" [label]="'labels.dcat:keyword'" [placeholder]="'modify.auth.form.placeholders.keyword'">
							</app-keyword-array-field>

							<app-theme-select-field
								formControlName="dcat:theme"
								[label]="'labels.dcat:theme'"
								[placeholder]="'modify.auth.form.placeholders.theme'"
							>
							</app-theme-select-field>
						</div>
					</div>

					<!-- Access & Classification Section -->
					<div class="card mb-4">
						<div class="card-header">
							<h4>{{ "modify.auth.form.sections.access" | translate }}</h4>
						</div>
						<div class="card-body">
							<app-enum-select-field
								formControlName="dct:accessRights"
								[label]="'labels.dct:accessRights'"
								[options]="accessRights"
								[required]="true"
								[translationPath]="'choices.dataset.dct:accessRights'"
							>
							</app-enum-select-field>

							<app-enum-select-field
								formControlName="bv:classification"
								[label]="'labels.bv:classification'"
								[options]="classificationLevels"
								[required]="true"
								[translationPath]="'choices.dataset.bv:classification'"
							>
							</app-enum-select-field>

							<app-enum-select-field
								formControlName="bv:personalData"
								[label]="'labels.bv:personalData'"
								[options]="personalDataCategories"
								[required]="true"
								[translationPath]="'choices.dataset.bv:personalData'"
							>
							</app-enum-select-field>

							<app-enum-select-field
								formControlName="adms:status"
								[label]="'labels.adms:status'"
								[options]="statuses"
								[required]="true"
								[translationPath]="'choices.dataset.adms:status'"
							>
							</app-enum-select-field>
						</div>
					</div>

					<!-- Publisher & Contact Section -->
					<div class="card mb-4">
						<div class="card-header">
							<h4>{{ "modify.auth.form.sections.publisher" | translate }}</h4>
						</div>
						<div class="card-body">
							<app-enum-select-field
								formControlName="dct:publisher"
								[label]="'labels.dct:publisher'"
								[options]="publishers"
								[required]="true"
								[translationPath]="'choices.dataset.dct:publisher'"
							>
							</app-enum-select-field>

							<div formGroupName="dcat:contactPoint">
								<h5>{{ "labels.dcat:contactPoint" | translate }}</h5>

								<div class="row">
									<div class="col-md-6">
										<mat-form-field class="w-100">
											<mat-label>{{ "modify.auth.form.contactName" | translate }} *</mat-label>
											<input matInput formControlName="schema:name" required />
											<mat-error *ngIf="datasetForm.get('dcat:contactPoint.schema:name')?.invalid && datasetForm.get('dcat:contactPoint.schema:name')?.touched">
												{{ "modify.auth.form.validation.required" | translate }}
											</mat-error>
										</mat-form-field>
									</div>
									<div class="col-md-6">
										<mat-form-field class="w-100">
											<mat-label>{{ "modify.auth.form.contactEmail" | translate }} *</mat-label>
											<input matInput type="email" formControlName="schema:email" required />
											<mat-error
												*ngIf="
													datasetForm.get('dcat:contactPoint.schema:email')?.hasError('required') && datasetForm.get('dcat:contactPoint.schema:email')?.touched
												"
											>
												{{ "modify.auth.form.validation.required" | translate }}
											</mat-error>
											<mat-error
												*ngIf="
													datasetForm.get('dcat:contactPoint.schema:email')?.hasError('email') && datasetForm.get('dcat:contactPoint.schema:email')?.touched
												"
											>
												{{ "modify.auth.form.validation.email" | translate }}
											</mat-error>
										</mat-form-field>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Metadata & Versioning Section -->
					<div class="card mb-4">
						<div class="card-header">
							<h4>{{ "modify.auth.form.sections.metadata" | translate }}</h4>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-4">
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.dct:issued" | translate }}</mat-label>
										<input matInput [matDatepicker]="issuePicker" formControlName="dct:issued" />
										<mat-datepicker-toggle matIconSuffix [for]="issuePicker"></mat-datepicker-toggle>
										<mat-datepicker #issuePicker></mat-datepicker>
									</mat-form-field>
								</div>
								<div class="col-md-4">
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.dct:modified" | translate }}</mat-label>
										<input matInput [matDatepicker]="modifiedPicker" formControlName="dct:modified" />
										<mat-datepicker-toggle matIconSuffix [for]="modifiedPicker"></mat-datepicker-toggle>
										<mat-datepicker #modifiedPicker></mat-datepicker>
									</mat-form-field>
								</div>
								<div class="col-md-4">
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.dcat:version" | translate }}</mat-label>
										<input matInput formControlName="dcat:version" placeholder="e.g., 1.0.0" />
									</mat-form-field>
								</div>
							</div>

							<div class="row">
								<div class="col-md-4">
									<app-enum-select-field
										formControlName="dct:accrualPeriodicity"
										[label]="'labels.dct:accrualPeriodicity'"
										[options]="accrualPeriocicites"
										[translationPath]="'choices.dataset.dct:accrualPeriodicity'"
									>
									</app-enum-select-field>
								</div>
								<div class="col-md-4">
									<app-enum-select-field
										formControlName="bv:typeOfData"
										[label]="'labels.bv:typeOfData'"
										[options]="dataTypes"
										[translationPath]="'choices.dataset.bv:typeOfData'"
									>
									</app-enum-select-field>
								</div>
								<div class="col-md-4">
									<mat-checkbox formControlName="bv:archivalValue" class="mt-4">
										{{ "labels.bv:archivalValue" | translate }}
									</mat-checkbox>
								</div>
							</div>
						</div>
					</div>

					<!-- Governance Section -->
					<div class="card mb-4">
						<div class="card-header">
							<h4>{{ "modify.auth.form.sections.governance" | translate }}</h4>
						</div>
						<div class="card-body">
							<app-affiliated-persons-field formControlName="prov:qualifiedAttribution" [label]="'labels.prov:qualifiedAttribution'">
							</app-affiliated-persons-field>
						</div>
					</div>

					<!-- External References Section -->
					<div class="card mb-4">
						<div class="card-header">
							<h4>{{ "modify.auth.form.sections.external" | translate }}</h4>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										<label class="form-label">{{ "labels.bv:externalCatalogs" | translate }}</label>
										<div class="external-catalogs">
											<mat-checkbox [checked]="isExternalCatalogSelected('I14Y')" (change)="onExternalCatalogChange('I14Y', $event.checked)" class="me-3">
												I14Y
											</mat-checkbox>
											<mat-checkbox
												[checked]="isExternalCatalogSelected('opendata.swiss')"
												(change)="onExternalCatalogChange('opendata.swiss', $event.checked)"
												class="me-3"
											>
												opendata.swiss
											</mat-checkbox>
											<mat-checkbox [checked]="isExternalCatalogSelected('geocat.ch')" (change)="onExternalCatalogChange('geocat.ch', $event.checked)">
												geocat.ch
											</mat-checkbox>
										</div>
										<small class="text-muted">{{ "modify.auth.form.help.externalCatalogs" | translate }}</small>
									</div>
								</div>
								<div class="col-md-6">
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.dcat:landingPage" | translate }}</mat-label>
										<input matInput formControlName="dcat:landingPage" type="url" placeholder="https://example.com" />
									</mat-form-field>
								</div>
							</div>
						</div>
					</div>

					<!-- Coverage & Legal Section -->
					<div class="card mb-4">
						<div class="card-header">
							<h4>{{ "modify.auth.form.sections.coverage" | translate }}</h4>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-12 mb-3">
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.dct:spatial" | translate }}</mat-label>
										<input matInput formControlName="dct:spatial" placeholder="e.g., Switzerland, Canton Bern" />
									</mat-form-field>
								</div>
							</div>
							<div formGroupName="dct:temporal" class="row">
								<div class="col-md-6">
									<mat-form-field class="w-100">
										<mat-label>{{ "modify.auth.form.labels.temporalStart" | translate }}</mat-label>
										<input matInput [matDatepicker]="temporalStartPicker" formControlName="dcat:start_date" />
										<mat-datepicker-toggle matIconSuffix [for]="temporalStartPicker"></mat-datepicker-toggle>
										<mat-datepicker #temporalStartPicker></mat-datepicker>
									</mat-form-field>
								</div>
								<div class="col-md-6">
									<mat-form-field class="w-100">
										<mat-label>{{ "modify.auth.form.labels.temporalEnd" | translate }}</mat-label>
										<input matInput [matDatepicker]="temporalEndPicker" formControlName="dcat:end_date" />
										<mat-datepicker-toggle matIconSuffix [for]="temporalEndPicker"></mat-datepicker-toggle>
										<mat-datepicker #temporalEndPicker></mat-datepicker>
									</mat-form-field>
								</div>
							</div>
						</div>
					</div>

					<!-- Business Context Section -->
					<div class="card mb-4">
						<div class="card-header">
							<h4>{{ "modify.auth.form.sections.business" | translate }}</h4>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-4">
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.bv:itSystem" | translate }}</mat-label>
										<input matInput formControlName="bv:itSystem" [placeholder]="'modify.auth.form.placeholders.itSystem' | translate" />
									</mat-form-field>
								</div>
								<div class="col-md-4">
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.bv:retentionPeriod" | translate }}</mat-label>
										<input matInput type="number" formControlName="bv:retentionPeriod" [placeholder]="'modify.auth.form.placeholders.retentionPeriod' | translate" />
									</mat-form-field>
								</div>
								<div class="col-md-4">
									<!-- Business Process field - could be expanded to textarea or array later -->
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.prov:wasGeneratedBy" | translate }}</mat-label>
										<input matInput formControlName="prov:wasGeneratedBy" [placeholder]="'modify.auth.form.placeholders.businessProcess' | translate" />
									</mat-form-field>
								</div>
							</div>
						</div>
					</div>

					<!-- Additional Metadata & Relationships Section -->
					<div class="card mb-4">
						<div class="card-header">
							<h4>{{ "modify.auth.form.sections.additional" | translate }}</h4>
						</div>
						<div class="card-body">
							<div class="row mb-3">
								<div class="col-md-12">
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.schema:comment" | translate }}</mat-label>
										<textarea matInput formControlName="schema:comment" rows="3" [placeholder]="'modify.auth.form.placeholders.comment' | translate"></textarea>
									</mat-form-field>
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-md-4">
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.bv:geoIdentifier" | translate }}</mat-label>
										<input matInput formControlName="bv:geoIdentifier" [placeholder]="'modify.auth.form.placeholders.geoIdentifier' | translate" />
									</mat-form-field>
								</div>
								<div class="col-md-4">
									<mat-form-field class="w-100">
										<mat-label>{{ "modify.auth.form.labels.imageUrl" | translate }}</mat-label>
										<input matInput formControlName="schema:image" type="url" placeholder="https://example.com/image.jpg" />
									</mat-form-field>
								</div>
								<div class="col-md-4">
									<mat-form-field class="w-100">
										<mat-label>{{ "labels.bv:abrogation" | translate }}</mat-label>
										<input matInput [matDatepicker]="abrogationPicker" formControlName="bv:abrogation" />
										<mat-datepicker-toggle matIconSuffix [for]="abrogationPicker"></mat-datepicker-toggle>
										<mat-datepicker #abrogationPicker></mat-datepicker>
									</mat-form-field>
								</div>
							</div>
							<div class="row">
								<div class="col-md-12">
									<label class="form-label">{{ "modify.auth.form.labels.relationships" | translate }}</label>
									<small class="form-text text-muted d-block mb-2"> {{ 'modify.auth.form.help.relationships' | translate }} </small>
									<div class="row">
										<div class="col-md-4">
											<mat-form-field class="w-100">
												<mat-label>{{ "labels.prov:wasDerivedFrom" | translate }}</mat-label>
												<input matInput formControlName="prov:wasDerivedFrom" [placeholder]="'modify.auth.form.placeholders.derivedFrom' | translate" />
											</mat-form-field>
										</div>
										<div class="col-md-4">
											<mat-form-field class="w-100">
												<mat-label>{{ "labels.dcat:inSeries" | translate }}</mat-label>
												<input matInput formControlName="dcat:inSeries" [placeholder]="'modify.auth.form.placeholders.inSeries' | translate" />
											</mat-form-field>
										</div>
										<div class="col-md-4">
											<mat-form-field class="w-100">
												<mat-label>{{ "labels.dct:replaces" | translate }}</mat-label>
												<input matInput formControlName="dct:replaces" [placeholder]="'modify.auth.form.placeholders.replaces' | translate" />
											</mat-form-field>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Distributions Section -->
					<div class="card mb-4">
						<div class="card-header">
							<h4>{{ "modify.auth.form.sections.distributions" | translate }}</h4>
						</div>
						<div class="card-body">
							<app-distribution-field formControlName="dcat:distribution" [label]="'labels.dcat:distribution'"> </app-distribution-field>
						</div>
					</div>

					<!-- Validation Summary -->
					<div *ngIf="datasetForm.invalid && datasetForm.touched && invalidFields.length > 0" class="alert alert-warning mb-4">
						<strong>{{ "modify.auth.form.validation.summary" | translate }}</strong>
						<p class="mb-2">{{ "modify.auth.form.validation.fillRequired" | translate }}</p>
						<ul class="mb-0">
							<li *ngFor="let field of invalidFields">{{ field }}</li>
						</ul>
					</div>

					<!-- Form Actions -->
					<div class="form-actions">
						<button type="button" class="btn btn-outline-secondary me-3" (click)="onCancel()">
							{{ "modify.auth.form.cancel" | translate }}
						</button>

						<button type="submit" [obButton]="'primary'" class="btn btn-primary" [disabled]="isLoading">
							<span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
							{{ "modify.auth.form.generateJson" | translate }}
						</button>
					</div>
				</form>
			</div>

			<!-- Submit Section -->
			<div *ngIf="showSubmitSection">
				<app-dataset-submit [formData]="datasetForm.value" [isEditMode]="isEditMode" [datasetId]="datasetId"> </app-dataset-submit>

				<div class="mt-3">
					<button type="button" class="btn btn-outline-secondary" (click)="onFormReset()">
						{{ "modify.auth.form.backToForm" | translate }}
					</button>
				</div>
			</div>
		</div>
	</div>
</div>
