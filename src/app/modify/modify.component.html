<div class="ob-container">
	<div>
		<!-- Header -->
		<div class="ob-flex ob-justify-between ob-items-center ob-mb-4">
			<h1>
				{{ (isEditMode ? "modify.auth.form.title.edit" : "modify.auth.form.title.new") | translate }}
			</h1>
			<div class="ob-flex ob-items-center ob-gap-2">
				<small class="ob-text-muted">{{ "modify.auth.form.selectedRepository" | translate }}:</small>
				<strong class="me-3">{{ getSelectedRepositoryDisplay() }}</strong>
				<a routerLink="/modify/auth" mat-button obButton="secondary" size="sm" *ngIf="!isDebugMode()">
					{{ "modify.auth.form.changeRepository" | translate }}
				</a>
			</div>
		</div>

		<!-- Dataset Form -->
		<div class="dataset-form-container" *ngIf="!showSubmitSection">
			<form [formGroup]="datasetForm">
				<mat-stepper [linear]="isLinear" orientation="vertical" #stepper class="vertical-stepper">
					<ng-template matStepperIcon="edit">
						<mat-icon svgIcon="pencil" />
						<span class="cdk-visually-hidden">{{ "i18n.stepper.editable.label" | translate }}</span>
					</ng-template>

					<ng-template matStepperIcon="error">
						<mat-icon svgIcon="exclamation" />
					</ng-template>

					<ng-template matStepperIcon="done">
						<mat-icon svgIcon="checkmark" />
						<span class="cdk-visually-hidden">{{ "i18n.stepper.completed.label" | translate }}</span>
					</ng-template>

					<ng-template matStepperIcon="number" let-index="index">
						{{index + 1}}
					</ng-template>
						<!-- Step 1: Basic Information -->
						<mat-step [completed]="isStepValid(0)" [optional]="isStepOptional(0)" [hasError]="!isStepValid(0) && (datasetForm.touched || submitAttempted)">
							<ng-template matStepLabel>{{ "modify.auth.form.sections.basic" | translate }}</ng-template>
							<div class="step-content">
							<app-multilingual-text-field
								formControlName="dct:title"
								[label]="'labels.dct:title'"
								[placeholder]="'modify.auth.form.placeholders.title'"
								[required]="true"
							>
							</app-multilingual-text-field>

							<app-multilingual-text-field
								formControlName="dct:description"
								[label]="'labels.dct:description'"
								[placeholder]="'modify.auth.form.placeholders.description'"
								[required]="true"
								[textarea]="true"
								[maxLength]="2000"
							>
							</app-multilingual-text-field>

							<app-keyword-array-field formControlName="dcat:keyword" [label]="'labels.dcat:keyword'" [placeholder]="'modify.auth.form.placeholders.keyword'">
							</app-keyword-array-field>

							<app-theme-select-field
								formControlName="dcat:theme"
								[label]="'labels.dcat:theme'"
								[placeholder]="'modify.auth.form.placeholders.theme'"
							>
							</app-theme-select-field>

						</div>
					</mat-step>

						<!-- Step 2: Access & Classification -->
						<mat-step [completed]="isStepValid(1)" [optional]="isStepOptional(1)" [hasError]="!isStepValid(1) && (datasetForm.touched || submitAttempted)">
							<ng-template matStepLabel>{{ "modify.auth.form.sections.access" | translate }}</ng-template>
							<div class="step-content">
							<app-enum-select-field
								formControlName="dct:accessRights"
								[label]="'labels.dct:accessRights'"
								[options]="accessRights"
								[required]="true"
								[translationPath]="'choices.dataset.dct:accessRights'"
							>
							</app-enum-select-field>

							<app-enum-select-field
								formControlName="bv:classification"
								[label]="'labels.bv:classification'"
								[options]="classificationLevels"
								[required]="true"
								[translationPath]="'choices.dataset.bv:classification'"
							>
							</app-enum-select-field>

							<app-enum-select-field
								formControlName="bv:personalData"
								[label]="'labels.bv:personalData'"
								[options]="personalDataCategories"
								[required]="true"
								[translationPath]="'choices.dataset.bv:personalData'"
							>
							</app-enum-select-field>

							<app-enum-select-field
								formControlName="adms:status"
								[label]="'labels.adms:status'"
								[options]="statuses"
								[required]="true"
								[translationPath]="'choices.dataset.adms:status'"
							>
							</app-enum-select-field>

						</div>
					</mat-step>

					<!-- Step 3: Publisher & Contact -->
					<mat-step [completed]="isStepValid(2)" [optional]="isStepOptional(2)" [hasError]="!isStepValid(2) && (datasetForm.touched || submitAttempted)">
							<ng-template matStepLabel>{{ "modify.auth.form.sections.publisher" | translate }}</ng-template>
							<div class="step-content">
							<app-enum-select-field
								formControlName="dct:publisher"
								[label]="'labels.dct:publisher'"
								[options]="publishers"
								[required]="true"
								[translationPath]="'choices.dataset.dct:publisher'"
							>
							</app-enum-select-field>

							<div formGroupName="dcat:contactPoint">
								<h5>{{ "labels.dcat:contactPoint" | translate }}</h5>

								<div class="ob-flex ob-flex-wrap ob-gap-4">
									<div class="ob-flex-1 ob-min-w-0">
										<mat-form-field class="ob-w-full required">
											<mat-label>{{ "modify.auth.form.contactName" | translate }}</mat-label>
											<input matInput formControlName="schema:name" required />
											<mat-error *ngIf="datasetForm.get('dcat:contactPoint.schema:name')?.invalid && datasetForm.get('dcat:contactPoint.schema:name')?.touched">
												{{ "modify.auth.form.validation.required" | translate }}
											</mat-error>
										</mat-form-field>
									</div>
									<div class="ob-flex-1 ob-min-w-0">
										<mat-form-field class="ob-w-full required">
											<mat-label>{{ "modify.auth.form.contactEmail" | translate }}</mat-label>
											<input matInput type="email" formControlName="schema:email" required />
											<mat-error
												*ngIf="
													datasetForm.get('dcat:contactPoint.schema:email')?.hasError('required') && datasetForm.get('dcat:contactPoint.schema:email')?.touched
												"
											>
												{{ "modify.auth.form.validation.required" | translate }}
											</mat-error>
											<mat-error
												*ngIf="
													datasetForm.get('dcat:contactPoint.schema:email')?.hasError('email') && datasetForm.get('dcat:contactPoint.schema:email')?.touched
												"
											>
												{{ "modify.auth.form.validation.email" | translate }}
											</mat-error>
										</mat-form-field>
									</div>
								</div>
							</div>

						</div>
					</mat-step>

					<!-- Step 4: Metadata & Versioning -->
					<mat-step [completed]="isStepValid(3)" [optional]="isStepOptional(3)" [hasError]="!isStepValid(3) && (datasetForm.touched || submitAttempted)">
							<ng-template matStepLabel>{{ "modify.auth.form.sections.metadata" | translate }}</ng-template>
							<div class="step-content">
							<div class="ob-flex ob-flex-wrap ob-gap-4">
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "labels.dct:issued" | translate }}</mat-label>
										<input matInput [matDatepicker]="issuePicker" formControlName="dct:issued" />
										<mat-datepicker-toggle matIconSuffix [for]="issuePicker"></mat-datepicker-toggle>
										<mat-datepicker #issuePicker></mat-datepicker>
									</mat-form-field>
								</div>
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "labels.dct:modified" | translate }}</mat-label>
										<input matInput [matDatepicker]="modifiedPicker" formControlName="dct:modified" />
										<mat-datepicker-toggle matIconSuffix [for]="modifiedPicker"></mat-datepicker-toggle>
										<mat-datepicker #modifiedPicker></mat-datepicker>
									</mat-form-field>
								</div>
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "labels.dcat:version" | translate }}</mat-label>
										<input matInput formControlName="dcat:version" placeholder="e.g., 1.0.0" />
									</mat-form-field>
								</div>
							</div>

							<div class="ob-flex ob-flex-wrap ob-gap-4">
								<div class="ob-flex-1 ob-min-w-0">
									<app-enum-select-field
										formControlName="dct:accrualPeriodicity"
										[label]="'labels.dct:accrualPeriodicity'"
										[options]="accrualPeriocicites"
										[translationPath]="'choices.dataset.dct:accrualPeriodicity'"
									>
									</app-enum-select-field>
								</div>
								<div class="ob-flex-1 ob-min-w-0">
									<app-enum-select-field
										formControlName="bv:typeOfData"
										[label]="'labels.bv:typeOfData'"
										[options]="dataTypes"
										[translationPath]="'choices.dataset.bv:typeOfData'"
									>
									</app-enum-select-field>
								</div>
								<div class="ob-flex-1 ob-min-w-0">
									<div class="ob-form-field">
										<mat-checkbox formControlName="bv:archivalValue" class="ob-checkbox-field">
											{{ "labels.bv:archivalValue" | translate }}
										</mat-checkbox>
									</div>
								</div>
							</div>
							</div>
						</mat-step>

					<!-- Step 5: Governance -->
					<mat-step [completed]="isStepValid(4)" [optional]="isStepOptional(4)" [hasError]="!isStepValid(4) && (datasetForm.touched || submitAttempted)">
							<ng-template matStepLabel>{{ "modify.auth.form.sections.governance" | translate }}</ng-template>
							<div class="step-content">
							<app-affiliated-persons-field formControlName="prov:qualifiedAttribution" [label]="'labels.prov:qualifiedAttribution'">
							</app-affiliated-persons-field>
							</div>
						</mat-step>

					<!-- Step 6: External References -->
					<mat-step [completed]="isStepValid(5)" [optional]="isStepOptional(5)" [hasError]="!isStepValid(5) && (datasetForm.touched || submitAttempted)">
							<ng-template matStepLabel>{{ "modify.auth.form.sections.external" | translate }}</ng-template>
							<div class="step-content">
							<div class="ob-flex ob-flex-wrap ob-gap-4">
								<div class="ob-flex-1 ob-min-w-0">
									<div class="ob-form-group">
										<label class="ob-form-label">{{ "labels.bv:externalCatalogs" | translate }}</label>
										<div class="external-catalogs">
											<mat-checkbox [checked]="isExternalCatalogSelected('I14Y')" (change)="onExternalCatalogChange('I14Y', $event.checked)" class="me-3">
												I14Y
											</mat-checkbox>
											<mat-checkbox
												[checked]="isExternalCatalogSelected('opendata.swiss')"
												(change)="onExternalCatalogChange('opendata.swiss', $event.checked)"
												class="me-3"
											>
												opendata.swiss
											</mat-checkbox>
											<mat-checkbox [checked]="isExternalCatalogSelected('geocat.ch')" (change)="onExternalCatalogChange('geocat.ch', $event.checked)">
												geocat.ch
											</mat-checkbox>
										</div>
										<small class="ob-text-muted">{{ "modify.auth.form.help.externalCatalogs" | translate }}</small>
									</div>
								</div>
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "labels.dcat:landingPage" | translate }}</mat-label>
										<input matInput formControlName="dcat:landingPage" type="url" placeholder="https://example.com" />
									</mat-form-field>
								</div>
							</div>
						</div>
					</mat-step>

					<!-- Step 7: Coverage & Legal -->
					<mat-step [completed]="isStepValid(6)" [optional]="isStepOptional(6)" [hasError]="!isStepValid(6) && (datasetForm.touched || submitAttempted)">
							<ng-template matStepLabel>{{ "modify.auth.form.sections.coverage" | translate }}</ng-template>
							<div class="step-content">
							<div class="ob-flex ob-flex-wrap ob-gap-4">
								<div class="ob-flex-1 ob-min-w-0 ob-mb-3">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "labels.dct:spatial" | translate }}</mat-label>
										<input matInput formControlName="dct:spatial" placeholder="e.g., Switzerland, Canton Bern" />
									</mat-form-field>
								</div>
							</div>
							<div formGroupName="dct:temporal" class="ob-flex ob-flex-wrap ob-gap-4">
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "modify.auth.form.labels.temporalStart" | translate }}</mat-label>
										<input matInput [matDatepicker]="temporalStartPicker" formControlName="dcat:start_date" />
										<mat-datepicker-toggle matIconSuffix [for]="temporalStartPicker"></mat-datepicker-toggle>
										<mat-datepicker #temporalStartPicker></mat-datepicker>
									</mat-form-field>
								</div>
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "modify.auth.form.labels.temporalEnd" | translate }}</mat-label>
										<input matInput [matDatepicker]="temporalEndPicker" formControlName="dcat:end_date" />
										<mat-datepicker-toggle matIconSuffix [for]="temporalEndPicker"></mat-datepicker-toggle>
										<mat-datepicker #temporalEndPicker></mat-datepicker>
									</mat-form-field>
								</div>
							</div>
							</div>
						</mat-step>

					<!-- Step 8: Business Context -->
					<mat-step [completed]="isStepValid(7)" [optional]="isStepOptional(7)" [hasError]="!isStepValid(7) && (datasetForm.touched || submitAttempted)">
							<ng-template matStepLabel>{{ "modify.auth.form.sections.business" | translate }}</ng-template>
							<div class="step-content">
							<div class="ob-flex ob-flex-wrap ob-gap-4">
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "labels.bv:itSystem" | translate }}</mat-label>
										<input matInput formControlName="bv:itSystem" [placeholder]="'modify.auth.form.placeholders.itSystem' | translate" />
									</mat-form-field>
								</div>
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "labels.bv:retentionPeriod" | translate }}</mat-label>
										<input matInput type="number" formControlName="bv:retentionPeriod" [placeholder]="'modify.auth.form.placeholders.retentionPeriod' | translate" />
									</mat-form-field>
								</div>
								<div class="ob-flex-1 ob-min-w-0">
									<!-- Business Process field - could be expanded to textarea or array later -->
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "labels.prov:wasGeneratedBy" | translate }}</mat-label>
										<input matInput formControlName="prov:wasGeneratedBy" [placeholder]="'modify.auth.form.placeholders.businessProcess' | translate" />
									</mat-form-field>
								</div>
							</div>
							</div>
						</mat-step>

					<!-- Step 9: Additional Metadata & Relationships -->
					<mat-step [completed]="isStepValid(8)" [optional]="isStepOptional(8)" [hasError]="!isStepValid(8) && (datasetForm.touched || submitAttempted)">
							<ng-template matStepLabel>{{ "modify.auth.form.sections.additional" | translate }}</ng-template>
							<div class="step-content">
							<div class="ob-w-full ob-mb-3">
								<mat-form-field class="ob-w-full">
									<mat-label>{{ "labels.schema:comment" | translate }}</mat-label>
									<textarea matInput formControlName="schema:comment" rows="3" [placeholder]="'modify.auth.form.placeholders.comment' | translate"></textarea>
								</mat-form-field>
							</div>
							<div class="ob-flex ob-flex-wrap ob-gap-4">
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "labels.bv:geoIdentifier" | translate }}</mat-label>
										<input matInput formControlName="bv:geoIdentifier" [placeholder]="'modify.auth.form.placeholders.geoIdentifier' | translate" />
									</mat-form-field>
								</div>
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "modify.auth.form.labels.imageUrl" | translate }}</mat-label>
										<input matInput formControlName="schema:image" type="url" placeholder="https://example.com/image.jpg" />
									</mat-form-field>
								</div>
								<div class="ob-flex-1 ob-min-w-0">
									<mat-form-field class="ob-w-full">
										<mat-label>{{ "labels.bv:abrogation" | translate }}</mat-label>
										<input matInput [matDatepicker]="abrogationPicker" formControlName="bv:abrogation" />
										<mat-datepicker-toggle matIconSuffix [for]="abrogationPicker"></mat-datepicker-toggle>
										<mat-datepicker #abrogationPicker></mat-datepicker>
									</mat-form-field>
								</div>
							</div>
							<div class="ob-w-full">
								<label class="ob-form-label">{{ "modify.auth.form.labels.relationships" | translate }}</label>
								<small class="form-text text-muted d-block mb-2"> {{ 'modify.auth.form.help.relationships' | translate }} </small>
								<div class="ob-flex ob-flex-wrap ob-gap-4">
									<div class="ob-flex-1 ob-min-w-0">
										<mat-form-field class="ob-w-full">
											<mat-label>{{ "labels.prov:wasDerivedFrom" | translate }}</mat-label>
											<input matInput formControlName="prov:wasDerivedFrom" [placeholder]="'modify.auth.form.placeholders.derivedFrom' | translate" />
										</mat-form-field>
									</div>
									<div class="ob-flex-1 ob-min-w-0">
										<mat-form-field class="ob-w-full">
											<mat-label>{{ "labels.dcat:inSeries" | translate }}</mat-label>
											<input matInput formControlName="dcat:inSeries" [placeholder]="'modify.auth.form.placeholders.inSeries' | translate" />
										</mat-form-field>
									</div>
									<div class="ob-flex-1 ob-min-w-0">
										<mat-form-field class="ob-w-full">
											<mat-label>{{ "labels.dct:replaces" | translate }}</mat-label>
											<input matInput formControlName="dct:replaces" [placeholder]="'modify.auth.form.placeholders.replaces' | translate" />
										</mat-form-field>
									</div>
								</div>
							</div>
						</div>
					</mat-step>

					<!-- Step 10: Distributions -->
					<mat-step [completed]="isStepValid(9)" [optional]="isStepOptional(9)" [hasError]="!isStepValid(9) && (datasetForm.touched || submitAttempted)">
						<ng-template matStepLabel>{{ "modify.auth.form.sections.distributions" | translate }}</ng-template>
						<div class="step-content">
							<app-distribution-field formControlName="dcat:distribution" [label]="'labels.dcat:distribution'"> </app-distribution-field>

						</div>
					</mat-step>
				</mat-stepper>

					<!-- Form Actions -->
					<div class="final-actions ob-mt-4 ob-flex ob-justify-end ob-gap-3">
						<button type="button" mat-button obButton="secondary" (click)="onFormReset()">
							{{ "modify.auth.form.reset" | translate }}
						</button>
						<button type="button" mat-button obButton="secondary" (click)="onCancel()">
							{{ "modify.auth.form.cancel" | translate }}
						</button>
						<button type="button" mat-button obButton="primary" (click)="onSubmit()" [disabled]="isLoading">
							{{ "modify.auth.form.submit" | translate }}
						</button>
					</div>

					<!-- Validation Summary -->
					<ob-alert *ngIf="datasetForm.invalid && datasetForm.touched && invalidFields.length > 0" type="warning" class="ob-mb-4">
						<strong>{{ "modify.auth.form.validation.summary" | translate }}</strong>
						<p class="ob-mb-2">{{ "modify.auth.form.validation.fillRequired" | translate }}</p>
						<ul class="ob-mb-0">
							<li *ngFor="let field of invalidFields">{{ field }}</li>
						</ul>
					</ob-alert>

				</form>
		</div>

		<!-- Submit Section -->
		<div *ngIf="showSubmitSection">
			<app-dataset-submit [formData]="datasetForm.value" [isEditMode]="isEditMode" [datasetId]="datasetId"> </app-dataset-submit>

			<div class="ob-mt-3">
				<button type="button" mat-button obButton="secondary" (click)="onFormReset()">
					{{ "modify.auth.form.backToForm" | translate }}
				</button>
			</div>
		</div>
	</div>
</div>
